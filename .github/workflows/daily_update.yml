name: Daily AI Stock Update

on:
  schedule:
    # æ¯å¤© UTC 22:30 (å°ç£æ™‚é–“ 06:30)
    - cron: '30 22 * * 1-5'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    # ğŸ”¥ è¨­å®šå…¨åŸŸç’°å¢ƒè®Šæ•¸ï¼Œç¢ºä¿æ‰€æœ‰æ­¥é©Ÿéƒ½èƒ½è®€å–åˆ° Secrets
    env:
      TF_CPP_MIN_LOG_LEVEL: '3'
      CUDA_VISIBLE_DEVICES: '-1'
      EMAIL_USER: ${{ secrets.EMAIL_USER }}
      EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # ğŸ”¥ [é—œéµä¿®æ­£] å¼·åˆ¶å‡ç´š yfinance åˆ°æœ€æ–°ç‰ˆï¼Œè§£æ±º Yahoo ä¸‹è¼‰éŒ¯èª¤
        # åŠ å…¥ --no-cache-dir ç¢ºä¿ä¸ä½¿ç”¨èˆŠçš„å¿«å–
        pip install --upgrade --no-cache-dir yfinance
        # å®‰è£å…¶ä»–å¿…è¦å¥—ä»¶
        pip install ta pandas numpy scikit-learn tensorflow-cpu streamlit
        
        # é¡¯ç¤º yfinance ç‰ˆæœ¬ (æ–¹ä¾¿é™¤éŒ¯)
        pip show yfinance

    - name: Run Market Scanner & Backtests
      run: |
        # 1. è·‘ç¦¿é·¹ç­–ç•¥ (Tab 1 & 2)
        python run_backtest.py || echo "run_backtest.py åŸ·è¡Œå¤±æ•—"

        # 2. è·‘ AI æƒæ (Tab 3 & 4)
        python ai_market_scanner.py || echo "ai_market_scanner.py åŸ·è¡Œå¤±æ•—"
        
        # 3. è·‘ AI æ­·å²å›æ¸¬ (æ›´æ–°è³‡é‡‘æ›²ç·š)
        python ai_backtest_2.py || echo "ai_backtest_2.py åŸ·è¡Œå¤±æ•—"
        python ai_backtest_ma30_2.py || echo "ai_backtest_ma30_2.py åŸ·è¡Œå¤±æ•—"

    - name: Commit and Push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        git add data/
        git commit -m "ğŸ¤– Auto-update daily stock data" || exit 0
        git push